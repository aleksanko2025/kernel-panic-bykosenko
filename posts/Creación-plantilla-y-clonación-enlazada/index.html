<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kernel Panic by Kosenko | Plantilla y clonación enlazada KVM/QEMU + libvirt</title>
  

  <link
    rel="icon"
    type="image/png"
    href="/assets/icons/favicon_kpk.png"
  />
  <link rel="stylesheet" href="/assets/css/post.css" />
  <link rel="stylesheet" href="/assets/css/syntax.css" />
  
  <link rel="stylesheet" href="/assets/css/common.css" />
  <script src="/assets/js/categories.js"></script>
  <script src="/assets/js/copy-code.js"></script>
  <script>
    const currentTheme = localStorage.getItem("theme");
    if (currentTheme) {
      document.documentElement.setAttribute(
        "data-theme",
        localStorage.getItem("theme")
      );
    }
  </script>
  
  <script defer src="/assets/js/lbox.js"></script>
  

  <!-- MathJax Configuration -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [
          ["$", "$"],
          ["\\(", "\\)"],
        ],
        displayMath: [
          ["$$", "$$"],
          ["\\[", "\\]"],
        ],
        processEscapes: true,
      },
      svg: {
        fontCache: "global",
      },
    };
  </script>
  <script
    type="text/javascript"
    id="MathJax-script"
    async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
  ></script>
</head>

  <body>
    <main>
      <header>
  <a class="site-title" href="/">Kernel Panic by Kosenko</a>
  <!-- dark/light mode -->
  <span id="dark-mode-toggle" style="cursor: pointer">
    <svg
      stroke="currentColor"
      fill="currentColor"
      stroke-width="0"
      viewBox="0 0 16 16"
      height="1.2em"
      width="1.2em"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1zm0 13V2a6 6 0 1 1 0 12z"
      ></path>
    </svg>
  </span>
</header>

      <section class="article">
        <div class="article-header">
          <h2 class="article-title">Plantilla y clonación enlazada KVM/QEMU + libvirt</h2>
          <small class="date">12 Oct 2025</small>
          <div class="categories">
            
            <a href="#!" class="category">IaC</a>
            
            <a href="#!" class="category">Virt-Manager</a>
            
            <a href="#!" class="category">KVM</a>
            
            <a href="#!" class="category">QEMU</a>
            
            <a href="#!" class="category">2ºASIR</a>
            
          </div>
        </div>
        <div class="content"><p><img src="https://pm1.aminoapps.com/6204/eae82405edfa2ffe445941d2e072ade2acfbd518_hq.jpg" alt="alt" /></p>

<p>Estos apuntes han sido elaborados a partir de la práctica personal, con inspiración y guía en los materiales creados por <strong>José Domingo Muñoz</strong>, a quien agradezco por compartir sus conocimientos y experiencias en este tema.</p>

<p>Este documento explico cómo crear una <strong>plantilla base de Debian 12</strong> en KVM/QEMU y cómo realizar <strong>clonaciones enlazadas</strong> para ahorrar espacio en disco y acelerar la creación de nuevas máquinas virtuales.</p>

<h2 id="instalación-y-configuración-inicial">Instalación y configuración inicial</h2>

<p>Primero debemos hacer una <strong>instalación de máquina normal</strong> y configurarla a nuestro gusto con las herramientas básicas que utilizaremos en cualquier máquina que creemos.</p>

<p>Una vez terminada la instalación y configuración, <strong>generalizamos la máquina</strong> para que los clones no hereden configuraciones como claves SSH, hostname, etc.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>virt-sysprep <span class="nt">-d</span> debian12 <span class="nt">--hostname</span> plantilla-debian12 <span class="nt">--firstboot-command</span> <span class="s2">"dpkg-reconfigure openssh-server"</span>
</code></pre></div></div>

<h2 id="compactar-la-imagen">Compactar la imagen</h2>

<p>Compactamos la imagen para eliminar bloques vacíos y reducir su tamaño en disco:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>virt-sparsify <span class="nt">--compress</span> /var/lib/libvirt/images/debian12.qcow2 /var/lib/libvirt/images/plantilla-debian12-comprimida.qcow2
</code></pre></div></div>

<p>Reemplazamos la imagen por la nueva comprimida:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo mv</span> /var/lib/libvirt/images/plantilla-debian12-comprimida.qcow2 /var/lib/libvirt/images/debian12.qcow2
</code></pre></div></div>

<h3 id="proteger-la-plantilla">Proteger la plantilla</h3>

<p>Para evitar encender accidentalmente la plantilla, configuramos la imagen como solo lectura:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo chmod </span>444 /var/lib/libvirt/images/debian12.qcow2
</code></pre></div></div>

<p>Podemos también cambiar el nombre de la máquina para mayor claridad:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>virsh domrename debian12 plantilla-debian12
</code></pre></div></div>

<h2 id="clonación-enlazada">Clonación enlazada</h2>

<p>Ahora creamos un volumen enlazado (backing store) basado en la plantilla base.
Este volumen no puede ser mayor que el tamaño de la plantilla.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>virsh domblkinfo plantilla-debian12 vda <span class="nt">--human</span>
</code></pre></div></div>

<p>Creamos el nuevo volumen enlazado:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>virsh vol-create-as default debian12-backing.qcow2 5G <span class="nt">--format</span> qcow2 <span class="nt">--backing-vol</span> debian12.qcow2 <span class="nt">--backing-vol-format</span> qcow2
</code></pre></div></div>

<p>También se puede hacer con qemu-img:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>qemu-img create <span class="nt">-f</span> qcow2 <span class="nt">-b</span> /var/lib/libvirt/images/debian12.qcow2 <span class="nt">-F</span> qcow2 /var/lib/libvirt/images/debian12-backing.qcow2 15G

virsh pool-refresh default
</code></pre></div></div>

<h2 id="creación-de-máquina-a-partir-del-backing-store">Creación de máquina a partir del backing store</h2>

<p>Creamos una nueva máquina virtual basada en el backing store utilizando virt-install:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>virt-install <span class="nt">--connect</span> qemu:///system <span class="se">\</span>
    <span class="nt">--virt-type</span> kvm <span class="se">\</span>
    <span class="nt">--name</span> otra-debian12 <span class="se">\</span>
    <span class="nt">--os-variant</span> debian12 <span class="se">\</span>
    <span class="nt">--disk</span> <span class="nv">path</span><span class="o">=</span>/var/lib/libvirt/images/debian12-backing.qcow2 <span class="se">\</span>
    <span class="nt">--memory</span> 2048 <span class="se">\</span>
    <span class="nt">--vcpus</span> 2 <span class="se">\</span>
    <span class="nt">--import</span>
</code></pre></div></div>

<p>También podemos hacerlo con virt-clone:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>virt-clone <span class="nt">--connect</span><span class="o">=</span>qemu:///system <span class="se">\</span>
    <span class="nt">--original</span> plantilla-debian12 <span class="se">\</span>
    <span class="nt">--name</span> otra-debian12 <span class="se">\</span>
    <span class="nt">--file</span> /var/lib/libvirt/images/debian12-backing.qcow2 <span class="se">\</span>
    <span class="nt">--preserve-data</span>
</code></pre></div></div>
</div>
      </section>
      <footer>
  <p>&copy; 1998 - 2025 | Kernel Panic by Kosenko</p>
</footer>
<script src="/assets/js/mode.js" defer></script>

    </main>
    <section id="category-modal-bg"></section>
<section id="category-modal">
  <h1 id="category-modal-title"></h1>
  <section id="category-modal-content"></section>
</section>

  </body>
</html>
